---
title: "Lecture 03"
author: "Alex Shpenev"
date: "1/27/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# A brief intro to Rmarkdown

In this **class** we will start using Rmarkdown. We will work with R notebooks, which are slightly different from what you might have been using before. Notebooks contains different types of information and are very flexible. You type in them as you would in a text editor, and your text would be displayed nicely when you "render" your notebook.

You can add formatting to your notebooks, but the approach is slightly different from, say, Microsoft Word.

Refer to the markdown cheat sheet to help you figure out how to do some of the things I show below:

I can make the text **bold**, *italic*, or [underlined]{.ul}. Note that underlining text is considered bad practice in R notebooks as it makes such text look as if it is a [hyperlink](https://www.upenn.edu/).

You can also make lists:

1.  That are numbered

2.  Just like that

Or lists that are not numbered:

-   Just like that

-   And that

You can also create tables and add captions to them:

| Time of the Day | Meal      | Activity                          |
|-----------------|-----------|-----------------------------------|
| Morning         | Breakfast | Wish you were still sleeping      |
| Afternoon       | Lunch     | Wish you were still sleeping      |
| Evening         | Dinner    | Wish you didn't have to go to bed |

: Table 1: My Day (and Other Misfortunes)

If you look at the top bar you will see many more buttons that can be used to create elements of a workbook. Clicking the rightmost button allows you to see the underlying code. It is not too scary, but it is also not too pretty. Eventually you will learn most of it.

At first it might seem very cumbersome, but there are benefits to using R Notebooks to any other format of homework submission.

The most important of those benefits is that your notebooks become fully reproducible. Say a dataset got modified, and all the calculations you did need to be redone. If you typed your answers in Word, you would need to manually make a lot of changes in your file. If your answers are in an R notebook, all you need to do is to render it again and all the field will be updated based on the new data that you provided.



# Data chunks

We create data chunks for R code that we are using. Think of data chunks as fragments of code from your script. Always leave at least one blank line between the text and the code chunk.

```{r}
library(tidyverse)
library(readr)
library(lubridate)
library(broom)
library(ggthemes)
library(ggsci)
```

Here is the (slightly condensed) code that we produced last class:

```{r}
kardashians <- read_csv("multiTimeline.csv", skip = 1)
kard_clean <- kardashians %>%
  rename(month = Month,
         kim = `Kim Kardashian: (Worldwide)`,
         khloe = `KhloÃ© Kardashian: (Worldwide)`,
         kourtney = `Kourtney Kardashian: (Worldwide)`,
         kendall = `Kendall Jenner: (Worldwide)`,
         kylie = `Kylie Jenner: (Worldwide)`) %>% 
  mutate_if(is.character, str_replace, pattern = "<", replacement = "") %>% 
  mutate_at(c("khloe", "kourtney", "kendall", "kylie"), as.numeric) %>% 
  separate(month, into = c("year", "month"), sep = "-", convert = TRUE) %>%
  mutate(day = 15, .after = month) %>%
  mutate(date = ymd(paste(year, month, day, sep="-")))

kard_summary <- kard_clean %>% 
  group_by(year) %>% 
  summarize_at(c("kim", "khloe", "kourtney", "kendall", "kylie"), mean)
```

What we want to do now is to plot these data


```{r}
kard_clean
```

Let's think about what is wrong with this table and how else we can improve it.


```{r}
kard_tidy <- kard_clean %>%
  pivot_longer(cols = c("kim", "khloe", "kourtney", "kendall", "kylie"),
               names_to = "name",
               values_to = "score")

kard_tidy
```

Now this is a tidy dataset and we can use it to plot 

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, group = name))
```

Nothing appears in this graph because we specified the aesthetics but never specified what to do with them

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line()
```

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() + 
  geom_smooth(method = "loess")
```

Are they on average growing in popularity or not?

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() + 
  geom_smooth(method = "lm")
```


We can modify the coordinate system

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  scale_y_log10()
```

We can also modify the labels

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians, Google Trends data",
       )
```

We can also modify the legend text


```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians, Google Trends data",
       ) +
  scale_color_discrete(name = "Name",
                       labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie"))
```

The grey background is not the most aesthetically pleasing so we can remove it:

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians, Google Trends data",
       ) +
  scale_color_discrete(name = "Name",
                       labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie")) +
  theme_classic()
```

There are a lot of cool themes inside `ggthemes` 

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians, Google Trends data",
       ) +
  scale_color_discrete(name = "Name",
                       labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie")) +
  theme_wsj()
```

Let's fix the title since it doesn't display properly

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the \n Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_color_discrete(name = "Name",
                       labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie")) +
  theme_wsj()
```

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_color_discrete(name = "Name",
                       labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie")) +
  theme_economist()
```


We might want to change the colors of the lines now

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_color_viridis_d(name = "Name",
                       labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie"),
                       option = "D") +
  theme_economist()
```

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_color_brewer(name = "Name",
                     labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie"),
                     type = "qual"
                       ) +
  theme_classic()
```

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_color_lancet(name = "Name",
                     labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie")
                       ) +
  theme_classic()
```

If none of the color palettes work, we can always create our own

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_line() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_color_manual(name = "Name",
                     labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie"),
                     values = c("#C9D2FF", "#F26379", "#4B67F2", "#F2C333", "#3FF262")) +
  theme_classic()
```


We can also try different aesthetics to see what works better.

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name)) +
  geom_point() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_color_lancet(name = "Name",
                     labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie")
                       ) +
  theme_classic()
```

```{r}
kard_tidy %>% 
  ggplot(aes(x = date, y = score, color = name, fill = name)) +
  geom_col() +
  labs(x = "Date",
       y = "Popularity",
       title = "The Popularity of the Kardashians",
       subtitle = "Google trends data"
       ) +
  scale_fill_lancet(name = "Name",
                     labels = c("Kendall", "Khloe", "Kim", "Kourtney", "Kylie")
                       ) +
  scale_color_discrete(guide = "none") +
  theme_classic()
```



```{r}
kard_tidy %>% 
  group_by(month, name) %>% 
  summarize(mean_score = mean(score)) %>% 
  ggplot(aes(x = month, y = mean_score, fill = name)) +
  geom_col(position = "dodge", alpha = 0) +
  geom_point() +
  geom_polygon(alpha = 0.2) + 
  scale_x_continuous(breaks = 1:12, labels =  month.abb[1:12]) + 
  coord_polar()
```

Maps are nothing more than just graphs, too
We can load the map of the US

```{r}
library(usmap)
```


and use it to plot the popularity of search terms by state


```{r}
plot_usmap(regions = "states")
```

```{r}
wawa <- read_csv("geoMap.csv", skip = 1)
wawa_clean <- wawa %>% rename(state = Region,
                wawa = `Wawa: (1/1/04 - 1/27/22)`) %>% 
  mutate(fips = fips(state))
  
plot_usmap(data = wawa_clean, regions = "states", values = "wawa") +
scale_fill_viridis_c()
```


